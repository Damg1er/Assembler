.model small
.stack 100h

.data
    MAX_BUFFER_SIZE EQU 200           ; ???????????? ?????? ??????
    buffer db MAX_BUFFER_SIZE dup(0)  ; ????? ??? ???????? 200 ????????
    msgInput db 'Vvedite stroku (maksimum 200 simvolov): $'
    msgOutput db 0Dh, 0Ah, 'Izmenennaya stroka: $'
    msgEnd db 0Dh, 0Ah, 'Konec vvoda.$'
    msgOverflow db 0Dh, 0Ah, 'Oshibka: perepleneniye bufera.$'
    length db 0                       ; ????? ????????? ??????

.code
main proc
    ; ????????????? ?????????
    mov ax, @data
    mov ds, ax

    ; ????? ????????? ? ?????
    mov dx, offset msgInput
    mov ah, 09h
    int 21h

    ; ???? ?????? ????????
    lea dx, buffer                ; ????????? ?? ?????
    mov byte ptr [buffer], MAX_BUFFER_SIZE ; ???????????? ?????
    mov ah, 0Ah                   ; ??????? ??? ????? ??????
    int 21h

    ; ???????? ???????????? ??????
    mov al, [buffer + 1]           ; ???????? ????? ????????? ?????? (?????? ????)
    cmp al, MAX_BUFFER_SIZE        ; ?????????? ? ???????????? ????????
    ja overflow_error              ; ???? ?????????, ????????? ? ??????
    mov [length], al               ; ????????? ?????

    ; ?????? ????, ?????????? 'c', 'a' ??? 't', ?? 'dog'
    lea si, buffer + 2             ; ????????? ?? ?????? ????????? ?????? (?????????? 2 ?????)
    mov cl, [length]               ; ????????? ????? ?????? ? CL
    xor di, di                     ; ??????? ??? ????? ?????? (di)

replace_loop:
    ; ????????? ?????? ??????
    mov al, [si]                   ; ????? ??????? ??????
    cmp al, 0                       ; ????????? ????? ??????
    je end_replace                  ; ???? ????? ??????, ???????

    ; ????????? ??????? ??????? ?????
    push si                        ; ????????? ????? ?????? ?????
    mov bx, 0                      ; ??????? ??? ????? ?????

    ; ?????????, ???????? ?? ??????? ?????? ????????, ?????? ?????????? ??? ?????????? ??????
check_word:
    mov al, [si]                   ; ????? ??????? ??????
    cmp al, 0                       ; ????????? ????? ??????
    je end_replace                  ; ???? ????? ??????, ???????
    cmp al, ' '                     ; ????????? ??????
    je replace_or_continue          ; ???? ??????, ????????? ? ???????? ??????
    cmp al, ','                     ; ????????? ?? ???????
    je replace_or_continue          ; ???? ???????, ????????? ? ???????? ??????
    cmp al, '.'                     ; ????????? ?? ?????
    je replace_or_continue          ; ???? ?????, ????????? ? ???????? ??????
    cmp al, '!'                     ; ????????? ?? ??????????????? ????
    je replace_or_continue          ; ???? ??????????????? ????, ????????? ? ???????? ??????
    cmp al, '?'                     ; ????????? ?? ?????????????? ????
    je replace_or_continue          ; ???? ?????????????? ????, ????????? ? ???????? ??????
    cmp al, 'c'                     ; ????????? ?? 'c'
    je replace_word                 ; ???? 'c', ???????? ?????
    cmp al, 'a'                     ; ????????? ?? 'a'
    je replace_word                 ; ???? 'a', ???????? ?????
    cmp al, 't'                     ; ????????? ?? 't'
    je replace_word                 ; ???? 't', ???????? ?????

    ; ????????? ? ?????????? ???????
    inc si
    inc bx
    jmp check_word                 ; ?????????? ?????????

replace_word:
    ; ???????? ????? ?? 'dog'
    pop si                          ; ???????????? ? ?????? ?????
    mov byte ptr [si], 'd'
    mov byte ptr [si + 1], 'o'
    mov byte ptr [si + 2], 'g'
    
    ; ??????? ??????? ?????, ??????? ?? ??????
    add si, 3                       ; ????????? ? ?????????? ??????? ????? 'dog'
    mov byte ptr [si], ' '          ; ????????????? ?????? ????? 'dog'
    inc si                          ; ??????????? ????????? ?? ????????? ??????
    
    ; ????????? ? ?????????? ???????
    jmp replace_loop               ; ?????????? ? ?????? ???????

replace_or_continue:
    ; ???? ????????? ?????? ??? ???? ??????????, ?????? ????????? ? ?????????? ???????
    inc si                          ; ??????? ? ?????????? ??????
    jmp replace_loop               ; ???????????? ? ?????? ?????

end_replace:
    ; ????????? ?????? '$' ? ????? ?????? ??? ??????????? ??????
    lea si, buffer + 2             ; ?????????? ?????? ???? (???????????? ?????) ? ???? ?????
    mov cl, [length]               ; ????????? ????? ?????? ? CL
    add si, cx                     ; ????????????? ????????? ?? ????? ??????
    mov byte ptr [si], '$'         ; ????????? '$' ? ????? ??????

    ; ??????? ????????? "Izmenennaya stroka:"
    mov dx, offset msgOutput
    mov ah, 09h                    ; ??????? ??? ?????? ??????
    int 21h

    ; ??????? ?????????? ??????
    lea dx, buffer + 2             ; ????????? ?? ?????? (?????????? 2 ?????)
    mov ah, 09h                    ; ??????? ??? ?????? ??????
    int 21h

    ; ?????????? ?????????
    mov dx, offset msgEnd
    mov ah, 09h
    int 21h

    ; ?????????? ?????????
    mov ax, 4C00h
    int 21h

overflow_error:
    ; ??????? ????????? ?? ?????? ????????????
    mov dx, offset msgOverflow
    mov ah, 09h
    int 21h

    ; ?????????? ?????????
    mov ax, 4C00h
    int 21h

main endp
end main
